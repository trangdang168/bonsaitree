import copy
import gzip
import json
import logging
import os
from collections import defaultdict
from itertools import combinations, product

import numpy as np
import pytest
import random

from ..bonsaitree import utils
from ..bonsaitree import distributions
from ..bonsaitree import point_predictor

from ..bonsaitree.bonsai import build_pedigree
from ..bonsaitree.copytools import deepcopy
from ..bonsaitree.pedigree_object import PedigreeObject, merge_pedigrees_on_founder, extend_up, extend_down, connect_pedigrees_through_founders
from ..bonsaitree.exceptions import *
from ..bonsaitree.analytical_likelihood_tools import *
from ..bonsaitree.connect_pedigree_tools import *
from ..bonsaitree.node_dict_tools import *
from ..bonsaitree.ibd_tools import *
from ..bonsaitree.build_pedigree import *
from ..bonsaitree.distributions import AUTO_GENOME_LENGTH as GENOME_LENGTH

from .convert_ids import translate_ids_to_nums_pedigrees, translate_ids_to_nums_ibds

FIXTURES_DIR = os.path.join(os.path.dirname(__file__), "fixtures")

INF = float('inf')

log = logging.getLogger(__name__)

# ================== Test utils

# goal: accurately remove the background ibd according to the current assumption
"""
INPUT FORMATS

IBD format:  genotype_id_1, genotype_id_2, chromosome, start, end, is_full_ibd, length (cM)
Pedigree Dict: the key is the id, the value is [sex, age, parent_1, parent_2]
Sex: Male = 1, Female = 0, None = None

"""


def test_one():
    up_dict1 = {
        1 : [None, None, -1, -2],
        2 : [None, None, -1, -2],
        3 : [None, None, -3, -4],
        4 : [None, None, -3, -4],
        -1 : [None, None, -5, -6],
        -3 : [None, None, -5, -7],
    }
    po1 = PedigreeObject(up_dict1)

    up_dict2 = {
        5 : [None, None]
    }
    po2 = PedigreeObject(up_dict2)

    ibd_seg_list = [
        [1, 5, '3', 37706267, 66391837, False, 28.025470733642578],
        [3, 5, '3', 37706267, 66391837, False, 28.025470733642578],
        [3, 5, '17', 12456159, 81041077, False, 96.75493621826172],
        [4, 5, '17', 55701470, 80890638, False, 46.832611083984375],
    ]

    new_ca1 = drop_background_ibd(
        ca1 = -5,
        ca2 = 5,
        po1 = po1,
        po2 = po2,
        ibd_seg_list = ibd_seg_list,
        alpha = 0.01,
    )

    assert(new_ca1 == -3)

def test_two():
    up_dict1 = {
        1 : [None, None, -1, -2],
        2 : [None, None, -1, -2],
        3 : [None, None, -3, -4],
        4 : [None, None, -3, -4],
        -1 : [None, None, -5, -6],
        -3 : [None, None, -5, -7],
    }
    po1 = PedigreeObject(up_dict1)

    up_dict2 = {
        5 : [None, None]
    }
    po2 = PedigreeObject(up_dict2)

    ibd_seg_list = [
        [1, 5, '3', 37706267, 66391837, False, 28.025470733642578],
        [3, 5, '3', 37706267, 66391837, False, 28.025470733642578],
        [3, 5, '17', 12456159, 81041077, False, 96.75493621826172],
        [4, 5, '17', 37706267, 66391837, False, 28.025470733642578],
    ]

    new_ca1 = drop_background_ibd(
        ca1 = -5,
        ca2 = 5,
        po1 = po1,
        po2 = po2,
        ibd_seg_list = ibd_seg_list,
        alpha = 0.01,
    )

    assert(new_ca1 == 3)


def test_three():
    up_dict1 = {
        1 : [None, None, -1, -2],
        2 : [None, None, -1, -2],
        3 : [None, None, -3, -4],
        4 : [None, None, -3, -4],
        -1 : [None, None, -5, -6],
        -3 : [None, None, -5, -7],
    }
    po1 = PedigreeObject(up_dict1)

    up_dict2 = {
        5 : [None, None]
    }
    po2 = PedigreeObject(up_dict2)

    ibd_seg_list = [
        [1, 5, '3', 37706267, 66391837, False, 28.025470733642578],
        [3, 5, '3', 37706267, 66391837, False, 28.025470733642578],
        [3, 5, '17', 55701470, 80890638, False, 46.832611083984375],
        [4, 5, '17', 55701470, 80890638, False, 46.832611083984375],
    ]

    new_ca1 = drop_background_ibd(
        ca1 = -5,
        ca2 = 5,
        po1 = po1,
        po2 = po2,
        ibd_seg_list = ibd_seg_list,
        alpha = 0.01,
    )

    assert(new_ca1 == -5)

def test_toy1():
    toy_dict1 = {
                    '1': [0, None, 'b', 'a'],
                    '2': [1, None, 'b', 'a'],
                    '3': [1, None, 'b', 'a'],
                    'a': [0, None, '0', '0'],
                    'b': [1, None, 'h', 'g'],
                    'c': [0, None, 'h', 'g'],
                    # 'd': [1, None, 'h', 'g'],
                    'g': [0, None, '0', '0'],
                    'h': [1, None, 'l', 'k'],
                    'i': [0, None, 'n', 'o'],
                    'j': [1, None, '0', '0'],
                    'k': [0, None, '0', '0'],
                    'l': [1, None, 'p', 'q'],
                }

    po1 = PedigreeObject(translate_ids_to_nums_pedigrees(toy_dict1))

    toy_dict2 = {
        '4': [1, None, 'd', 'e'],
        '5': [2, None, 'd', 'e'],
        'e': [2, None, 'l', 'm'],
    }

    po2 = PedigreeObject(translate_ids_to_nums_pedigrees(toy_dict2))

    # original segments
    ibd_seg_list_truth =[
        ['1', '2', '21', 15225121, 31491707, False, 12.383539],
        # ['1', '2', '21', 10867286, 11158632, False, .911326],
        ['1', '3', '21', 11159780, 31491707, False, 14.737657],
        ['1', '3', '21', 11159780, 31491707, False, 14.737657],
        ['1', '3', '21', 31492197, 48097120, False, 15.100822],
        # ['1', '3', '21', 10867286, 11158632, False, .911326],
        ['1', '5', '21', 10867286, 48097120, False, 30.747429],
        ['2', '3', '21', 15225121, 48097120, False, 27.481983],
        ['2', '6', '21', 10867286, 36226702, False, 27.282493],
        ['2', '6', '21', 42427818, 48097120, False, 2.299955],
        ['2', '7', '21', 10867286, 36226702, False, 27.282493],
        ['2', '7', '21', 42427818, 48097120, False, 2.299955],
        ['2', '8', '21', 10867286, 36226702, False, 27.282493],
        ['2', '8', '21', 42427818, 48097120, False, 2.299955],
        ['2', '4', '21', 42427818, 48097120, False, 2.299955],
        # ['2', '4', '21', 36228656, 42336643, False, -2.1892]
        ['2', '5', '21', 37477939, 42427353, False, 3.675311],
        ['3', '5', '21', 10867286, 48097120, False, 30.747429],
        ['6', '7', '21', 10867286, 48097120, False, 30.747429],
        ['6', '8', '21', 42186395, 48097120, False, -3.577975],
        ['6', '8', '21', 38091481, 42182870, False, 8.217810],
        ['6', '8', '21', 38091481, 42182870, False, 8.217810],
        ['6', '8', '21', 10867286, 38090081, False, 26.106673],
        ['4', '6', '21', 42342787, 48097120, False, 5.659791],
        ['7', '8', '21', 42186395, 48097120, False, -3.577975],
        ['7', '8', '21', 42186395, 48097120, False, -3.577975],
        ['7', '8', '21', 38091481, 42182870, False, 8.217810],
        ['7', '8', '21', 10867286, 38090081, False, 26.106673],
        ['7', '8', '21', 10867286, 38090081, False, 26.106673],
        ['4', '7', '21', 42342787, 48097120, False, 5.659791],
        ['4', '8', '21', 42342787, 48097120, False, 5.659791],
        ['4', '4', '21', 39834815, 41443417, False, -8.113669],
        ['4', '5', '21', 22817497, 42336643, False, 15.385181],
]

    ibd_seg_list_germline = [
        ['1', '4',	'21', 15319116, 21839933, False, 15.194	],
        ['2', '4',	'21', 15319116, 21839933, False, 15.194	],
        ['3', '4',	'21', 15319116, 21839933, False, 15.194	],
        ['4', '4',	'21', 10867286, 21839933, False, 16.760	],
        ['1', '4',	'21', 15319116, 22782845, False, 17.214	],
        ['2', '4',	'21', 15319116, 22782845, False, 17.214	],
        ['3', '4',	'21', 15319116, 22782845, False, 17.214	],
        ['4', '5',	'21', 22782861, 29985905, False, 10.909	],
        ['1', '2',	'21', 15319116, 31427808, False, 	29.053],	
        ['1', '3',	'21', 11297109, 31427808, False, 	30.088],	
        ['2', '6',	'21', 10867286, 36173761, False, 	37.559],	
        ['2', '7',	'21', 10867286, 36173761, False, 	37.559],	
        ['2', '8',	'21', 10867286, 36173761, False, 	37.559],	
        ['4', '5',	'21', 30124343, 37478248, False, 10.308	],
        ['7', '8',	'21', 10867286, 38039372, False, 	40.986],	
        ['2', '4',	'21', 39856727, 41396998, False, 3.589],	
        ['4', '4',	'21', 39856727, 41396998, False, 3.589],	
       ['4', '5',	'21', 39856727, 41396998, False, 3.589],	
       ['6', '8',	'21', 38181451, 42171704, False, 7.848],	
        ['2', '4',	'21', 36317666, 42317996, False, 12.016	],
        ['2', '5',	'21', 37480993, 42317996, False, 10.151	],
        ['4', '5',	'21', 37480993, 42317996, False, 10.151	],
        ['1', '1',	'21', 43872564, 46307297, False, 4.310],        
        ['1', '3',	'21', 43872564, 46307297, False, 4.310],
        ['1', '5',	'21', 43872564, 46307297, False, 4.310],        
        ['1', '3',	'21', 10867286, 48097120, False, 	62.728],	
        ['1', '5',	'21', 10867286, 48097120, False, 	62.728],	
        ['2', '6',	'21', 42490623, 48097120, False, 12.133	],
        ['2', '7',	'21', 42490623, 48097120, False, 12.133	],
        ['2', '8',	'21', 42490623, 48097120, False, 12.133	],
        ['2', '4',	'21', 42490623, 48097120, False, 12.133	],
        ['2', '3',	'21', 15319116, 48097120, False, 	61.162],	
        ['3', '5',	'21', 10867286, 48097120, False, 	62.728],	
        ['6', '7',	'21', 10867286, 48097120, False, 	62.728],	
        ['6', '8',	'21', 10867286, 48097120, False, 	62.728],	
        ['6', '4',	'21', 42490623, 48097120, False, 12.133	],
        ['7', '8',	'21', 10867286, 48097120, False, 	62.728],	
        ['7', '4',	'21', 42490623, 48097120, False, 12.133	],
        ['7', '8',	'21', 42172232, 48097120, False, 13.294	],
        ['8', '4',	'21', 42490623, 48097120, False, 12.133	],
    ]

    ibd_seg_list_germline = translate_ids_to_nums_ibds(ibd_seg_list_germline)

    new_ca1 = drop_background_ibd(
        ca1 = -13,
        ca2 = -5,
        po1 = po1,
        po2 = po2,
        ibd_seg_list = ibd_seg_list_germline,
        alpha = 0.01,
    )

    assert(new_ca1 == -13)


def test_toy2():
    toy_dict1 = {
                    '1': [0, None, 'b', 'a'],
                    '2': [1, None, 'b', 'a'],
                    '3': [1, None, 'b', 'a'],
                    'a': [0, None, '0', '0'],
                    'b': [1, None, 'h', 'g'],
                    # 'c': [0, None, 'h', 'g'], so that it doesnt get confused
                    # 'd': [1, None, 'h', 'g'],
                    'g': [0, None, '0', '0'],
                    'h': [1, None, 'l', 'k'],
                    'i': [0, None, 'n', 'o'],
                    'j': [1, None, '0', '0'],
                    'k': [0, None, '0', '0'],
                    'l': [1, None, 'p', 'q'],
                    'n': [1, None, 'p', 'q']
                }

    po1 = PedigreeObject(translate_ids_to_nums_pedigrees(toy_dict1))

    toy_dict2 = {
         'n': [1, None, 'p', 'q'], 
         'o': [0, None, '0', '0'], 
         'i': [0, None, 'n', 'o'], 
         'j': [1, None, '0', '0'], 
         'f': [1, None, 'j', 'i'], 
         'c': [0, None, 'h', 'g'],
         'h': [1, None, 'l', 'k'],
         '6': [0, None, 'f', 'c'], 
         '7': [0, None, 'f', 'c'], 
         '8': [0, None, 'f', 'c'], 

    }

    po2 = PedigreeObject(translate_ids_to_nums_pedigrees(toy_dict2))

    # original segments
    ibd_seg_list_truth =[
        ['1', '2', '21', 15225121, 31491707, False, 12.383539],
        # ['1', '2', '21', 10867286, 11158632, False, .911326],
        ['1', '3', '21', 11159780, 31491707, False, 14.737657],
        ['1', '3', '21', 11159780, 31491707, False, 14.737657],
        ['1', '3', '21', 31492197, 48097120, False, 15.100822],
        # ['1', '3', '21', 10867286, 11158632, False, .911326],
        ['1', '5', '21', 10867286, 48097120, False, 30.747429],
        ['2', '3', '21', 15225121, 48097120, False, 27.481983],
        ['2', '6', '21', 10867286, 36226702, False, 27.282493],
        ['2', '6', '21', 42427818, 48097120, False, 2.299955],
        ['2', '7', '21', 10867286, 36226702, False, 27.282493],
        ['2', '7', '21', 42427818, 48097120, False, 2.299955],
        ['2', '8', '21', 10867286, 36226702, False, 27.282493],
        ['2', '8', '21', 42427818, 48097120, False, 2.299955],
        ['2', '4', '21', 42427818, 48097120, False, 2.299955],
        # ['2', '4', '21', 36228656, 42336643, False, -2.1892]
        ['2', '5', '21', 37477939, 42427353, False, 3.675311],
        ['3', '5', '21', 10867286, 48097120, False, 30.747429],
        ['6', '7', '21', 10867286, 48097120, False, 30.747429],
        ['6', '8', '21', 42186395, 48097120, False, -3.577975],
        ['6', '8', '21', 38091481, 42182870, False, 8.217810],
        ['6', '8', '21', 38091481, 42182870, False, 8.217810],
        ['6', '8', '21', 10867286, 38090081, False, 26.106673],
        ['4', '6', '21', 42342787, 48097120, False, 5.659791],
        ['7', '8', '21', 42186395, 48097120, False, -3.577975],
        ['7', '8', '21', 42186395, 48097120, False, -3.577975],
        ['7', '8', '21', 38091481, 42182870, False, 8.217810],
        ['7', '8', '21', 10867286, 38090081, False, 26.106673],
        ['7', '8', '21', 10867286, 38090081, False, 26.106673],
        ['4', '7', '21', 42342787, 48097120, False, 5.659791],
        ['4', '8', '21', 42342787, 48097120, False, 5.659791],
        ['4', '4', '21', 39834815, 41443417, False, -8.113669],
        ['4', '5', '21', 22817497, 42336643, False, 15.385181],
]

    ibd_seg_list_germline = [
        ['1', '4',	'21', 15319116, 21839933, False, 15.194	],
        ['2', '4',	'21', 15319116, 21839933, False, 15.194	],
        ['3', '4',	'21', 15319116, 21839933, False, 15.194	],
        ['4', '4',	'21', 10867286, 21839933, False, 16.760	],
        ['1', '4',	'21', 15319116, 22782845, False, 17.214	],
        ['2', '4',	'21', 15319116, 22782845, False, 17.214	],
        ['3', '4',	'21', 15319116, 22782845, False, 17.214	],
        ['4', '5',	'21', 22782861, 29985905, False, 10.909	],
        ['1', '2',	'21', 15319116, 31427808, False, 	29.053],	
        ['1', '3',	'21', 11297109, 31427808, False, 	30.088],	
        ['2', '6',	'21', 10867286, 36173761, False, 	37.559],	
        ['2', '7',	'21', 10867286, 36173761, False, 	37.559],	
        ['2', '8',	'21', 10867286, 36173761, False, 	37.559],	
        ['4', '5',	'21', 30124343, 37478248, False, 10.308	],
        ['7', '8',	'21', 10867286, 38039372, False, 	40.986],	
        ['2', '4',	'21', 39856727, 41396998, False, 3.589],	
        ['4', '4',	'21', 39856727, 41396998, False, 3.589],	
       ['4', '5',	'21', 39856727, 41396998, False, 3.589],	
       ['6', '8',	'21', 38181451, 42171704, False, 7.848],	
        ['2', '4',	'21', 36317666, 42317996, False, 12.016	],
        ['2', '5',	'21', 37480993, 42317996, False, 10.151	],
        ['4', '5',	'21', 37480993, 42317996, False, 10.151	],
        ['1', '1',	'21', 43872564, 46307297, False, 4.310],        
        ['1', '3',	'21', 43872564, 46307297, False, 4.310],
        ['1', '5',	'21', 43872564, 46307297, False, 4.310],        
        ['1', '3',	'21', 10867286, 48097120, False, 	62.728],	
        ['1', '5',	'21', 10867286, 48097120, False, 	62.728],	
        ['2', '6',	'21', 42490623, 48097120, False, 12.133	],
        ['2', '7',	'21', 42490623, 48097120, False, 12.133	],
        ['2', '8',	'21', 42490623, 48097120, False, 12.133	],
        ['2', '4',	'21', 42490623, 48097120, False, 12.133	],
        ['2', '3',	'21', 15319116, 48097120, False, 	61.162],	
        ['3', '5',	'21', 10867286, 48097120, False, 	62.728],	
        ['6', '7',	'21', 10867286, 48097120, False, 	62.728],	
        ['6', '8',	'21', 10867286, 48097120, False, 	62.728],	
        ['6', '4',	'21', 42490623, 48097120, False, 12.133	],
        ['7', '8',	'21', 10867286, 48097120, False, 	62.728],	
        ['7', '4',	'21', 42490623, 48097120, False, 12.133	],
        ['7', '8',	'21', 42172232, 48097120, False, 13.294	],
        ['8', '4',	'21', 42490623, 48097120, False, 12.133	],
    ]

    ibd_seg_list_germline = translate_ids_to_nums_ibds(ibd_seg_list_germline)

    new_ca1 = drop_background_ibd(
        ca1 = -3,
        ca2 = -6,
        po1 = po1,
        po2 = po2,
        ibd_seg_list = ibd_seg_list_germline,
        alpha = 0.01,
    )

    assert(new_ca1 == 2)

def test_toy4():
    """
    error rate is 0.005, toy3 germline
    """

    toy_dict1 = {
                    '1': [0, None, 'b', 'a'],
                    '2': [1, None, 'b', 'a'],
                    '3': [1, None, 'b', 'a'],
                    'a': [0, None, '0', '0'],
                    'b': [1, None, 'h', 'g'],
                    # 'c': [0, None, 'h', 'g'], so that it doesnt get confused
                    # 'd': [1, None, 'h', 'g'],
                    'g': [0, None, '0', '0'],
                    'h': [1, None, 'l', 'k'],
                    'i': [0, None, 'n', 'o'],
                    'j': [1, None, '0', '0'],
                    'k': [0, None, '0', '0'],
                    'l': [1, None, 'p', 'q'],
                    'n': [1, None, 'p', 'q']
                }

    po1 = PedigreeObject(translate_ids_to_nums_pedigrees(toy_dict1))

    toy_dict2 = {
         'n': [1, None, 'p', 'q'], 
         'o': [0, None, '0', '0'], 
         'i': [0, None, 'n', 'o'], 
         'j': [1, None, '0', '0'], 
         'f': [1, None, 'j', 'i'], 
         'c': [0, None, 'h', 'g'],
         'h': [1, None, 'l', 'k'],
         '6': [0, None, 'f', 'c'], 
         '7': [0, None, 'f', 'c'], 
         '8': [0, None, 'f', 'c'], 

    }

    po2 = PedigreeObject(translate_ids_to_nums_pedigrees(toy_dict2))

    ibd_seg_list_germline  = [['6', '8', '21', 14680815, 16598779, False, 3.539], ['2', '6', '21', 15065012, 16865920, False, 3.926], ['7', '8', '21', 15319116, 16865920, False, 3.344], ['2', '8', '21', 15065012, 17480967, False, 4.784], ['7', '8', '21', 14431442, 17480967, False, 5.16], ['1', '3', '21', 16175496, 17877676, False, 5.064], ['2', '3', '21', 15319116, 17877676, False, 6.727], ['2', '4', '21', 16730862, 17877676, False, 3.62], ['3', '4', '21', 15606034, 17877676, False, 6.272], ['3', '5', '21', 15733013, 18125746, False, 7.195], ['1', '5', '21', 15733013, 18251997, False, 7.384], ['1', '4', '21', 16175496, 18528193, False, 6.779], ['6', '8', '21', 17611247, 18663456, False, 4.155], ['2', '7', '21', 15065012, 18770485, False, 9.355], ['6', '7', '21', 17013303, 18770485, False, 4.991], ['7', '8', '21', 17611247, 18770485, False, 4.353], ['2', '6', '21', 17763215, 19535646, False, 5.648], ['1', '3', '21', 18006203, 19818635, False, 4.53], ['1', '4', '21', 15319116, 19818635, False, 11.957], ['7', '8', '21', 17013303, 19818635, False, 8.175], ['1', '3', '21', 14790478, 20077598, False, 13.026], ['2', '4', '21', 18006203, 20344981, False, 5.211], ['1', '2', '21', 16429911, 20440369, False, 10.682], ['2', '7', '21', 18901049, 20440369, False, 3.71], ['2', '8', '21', 17611247, 20440369, False, 8.538], ['2', '3', '21', 18006203, 20440369, False, 5.53], ['2', '4', '21', 16024113, 20440369, False, 11.673], ['7', '8', '21', 18901049, 21028203, False, 4.547], ['1', '4', '21', 19166603, 21170848, False, 4.024], ['3', '4', '21', 15319116, 21170848, False, 14.012], ['4', '4', '21', 14431442, 21170848, False, 14.969], ['6', '8', '21', 19028953, 21839933, False, 5.791], ['1', '5', '21', 20207323, 21984941, False, 3.101], ['1', '3', '21', 20207323, 21984941, False, 3.101], ['2', '6', '21', 20592790, 22260450, False, 3.488], ['6', '7', '21', 19412239, 22782845, False, 6.912], ['2', '7', '21', 21028420, 23342198, False, 4.468], ['7', '8', '21', 20848979, 23342198, False, 4.895], ['1', '5', '21', 23074492, 25444788, False, 3.292], ['1', '3', '21', 22262801, 25444788, False, 4.376], ['6', '7', '21', 23457062, 27574086, False, 4.67], ['3', '5', '21', 27950742, 29855737, False, 3.696], ['7', '8', '21', 26324114, 29855737, False, 5.808], ['2', '8', '21', 27438828, 30504413, False, 5.227], ['3', '5', '21', 30504600, 33347294, False, 3.562], ['2', '6', '21', 28860202, 33642060, False, 6.04], ['2', '7', '21', 31712613, 33929649, False, 3.478], ['6', '7', '21', 31049037, 33929649, False, 4.214], ['7', '8', '21', 32746152, 34679986, False, 3.275], ['4', '5', '21', 32746152, 34679986, False, 3.275], ['7', '8', '21', 32907325, 35094068, False, 3.029], ['2', '6', '21', 34081608, 36173761, False, 3.042], ['1', '3', '21', 34582298, 36458073, False, 3.465], ['6', '8', '21', 35177883, 36856844, False, 3.765], ['4', '5', '21', 34809809, 37478248, False, 4.316], ['6', '8', '21', 36992207, 39273436, False, 3.218], ['2', '3', '21', 38453067, 40454243, False, 3.542], ['4', '5', '21', 37620820, 40454243, False, 5.244], ['7', '8', '21', 38995241, 40843478, False, 3.594], ['6', '7', '21', 39402317, 41255241, False, 3.394], ['2', '4', '21', 40141321, 41396998, False, 3.009], ['1', '5', '21', 40019865, 41543670, False, 3.741], ['2', '4', '21', 40141321, 41543670, False, 3.423], ['3', '5', '21', 40019865, 41543670, False, 3.741], ['2', '5', '21', 40141321, 42317996, False, 5.501], ['7', '8', '21', 41699120, 43000022, False, 3.858], ['7', '8', '21', 42738252, 43723353, False, 3.392], ['1', '5', '21', 41699120, 44022683, False, 7.479], ['2', '3', '21', 42620275, 44353765, False, 5.076], ['1', '3', '21', 43165945, 44491551, False, 3.325], ['6', '7', '21', 43000163, 44491551, False, 4.315], ['6', '8', '21', 43165945, 44491551, False, 3.325], ['6', '4', '21', 43165945, 44491551, False, 3.325], ['1', '3', '21', 44180536, 46307297, False, 3.705], ['1', '5', '21', 44180536, 46307297, False, 3.705], ['7', '8', '21', 44180536, 46620335, False, 4.397], ['1', '3', '21', 45661063, 46988579, False, 3.049], ['2', '8', '21', 43446722, 46988579, False, 7.514], ['3', '5', '21', 41699120, 46988579, False, 13.249], ['2', '6', '21', 46007955, 48097120, False, 3.48], ['2', '4', '21', 46007955, 48097120, False, 3.48], ['6', '8', '21', 44631429, 48097120, False, 5.606], ['6', '4', '21', 46007955, 48097120, False, 3.48], ['8', '4', '21', 44180536, 48097120, False, 6.51]]
    ibd_seg_list_germline = translate_ids_to_nums_ibds(ibd_seg_list_germline)

    new_ca1 = drop_background_ibd(
        ca1 = -3,
        ca2 = -6,
        po1 = po1,
        po2 = po2,
        ibd_seg_list = ibd_seg_list_germline,
        alpha = 0.01,
    )

    assert(new_ca1 == 2)